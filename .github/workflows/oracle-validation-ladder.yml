name: Oracle Validation Ladder

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 2"

concurrency:
  group: oracle-validation-ladder-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  oracle-ladder:
    name: oracle-validation-ladder
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Checkout html-parser dependency
        run: |
          set -euo pipefail
          if [ ! -d ../html-parser ]; then
            git clone --depth 1 https://github.com/Ismail-elkorchi/html-parser.git ../html-parser
          fi

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm

      - name: Install
        run: npm ci

      - name: Run oracle runtime validation
        run: npm run eval:oracle-runtime:release

      - name: Run oracle superiority check
        run: npm run eval:oracle-superiority:release

      - name: Run oracle fingerprint drift check
        run: npm run eval:oracle-fingerprint:release

      - name: Run oracle supply-chain check
        run: npm run eval:oracle-supply-chain:release

      - name: Upload oracle ladder reports
        uses: actions/upload-artifact@v6
        with:
          name: oracle-validation-reports
          path: |
            reports/eval-oracle-runtime-summary.json
            reports/eval-oracle-superiority-summary.json
            reports/eval-oracle-fingerprint-summary.json
            reports/eval-oracle-supply-chain-summary.json
            reports/oracle-runtime.json
            reports/oracle-supply-chain.json
            scripts/oracles/oracle-image.lock.json
