name: Oracle Validation Ladder

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 2"

concurrency:
  group: oracle-validation-ladder-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  oracle-ladder:
    name: oracle-validation-ladder
    runs-on: ubuntu-latest
    timeout-minutes: 90

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Checkout html-parser dependency
        run: |
          set -euo pipefail
          if [ ! -d ../html-parser ]; then
            git clone --depth 1 https://github.com/Ismail-elkorchi/html-parser.git ../html-parser
          fi

      - name: Setup Node
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "24"
          cache: npm

      - name: Install
        run: npm ci

      - name: Restore oracle image cache
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: tmp/oracle-image
          key: ${{ runner.os }}-oracle-image-${{ hashFiles('scripts/oracles/oracle-image.lock.json') }}

      - name: Prepare oracle image
        run: npm run oracle:image:prepare

      - name: Run oracle runtime validation
        run: npm run eval:oracle-runtime:release

      - name: Run oracle lock refresh diff validation
        run: npm run eval:oracle-lock-refresh-diff:release

      - name: Run oracle superiority check
        run: npm run eval:oracle-superiority:release

      - name: Run oracle fingerprint drift check
        run: npm run eval:oracle-fingerprint:release

      - name: Run oracle supply-chain check
        run: npm run eval:oracle-supply-chain:release

      - name: Upload oracle ladder reports
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: oracle-validation-reports
          path: |
            reports/eval-oracle-runtime-summary.json
            reports/eval-oracle-superiority-summary.json
            reports/eval-oracle-fingerprint-summary.json
            reports/eval-oracle-supply-chain-summary.json
            reports/oracle-runtime.json
            reports/oracle-lock-refresh-diff.json
            reports/oracle-supply-chain.json
            scripts/oracles/oracle-image.lock.json
