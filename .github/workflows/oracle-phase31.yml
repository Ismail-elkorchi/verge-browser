name: Oracle Phase31

on:
  workflow_dispatch:
  schedule:
    - cron: "0 4 * * 1"

concurrency:
  group: oracle-phase31-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  phase31:
    name: phase31-real-oracles
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Checkout html-parser dependency
        run: |
          set -euo pipefail
          if [ ! -d ../html-parser ]; then
            git clone --depth 1 https://github.com/Ismail-elkorchi/html-parser.git ../html-parser
          fi

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: npm

      - name: Install
        run: npm ci

      - name: Run phase31 validation
        run: npm run eval:phase31:release

      - name: Upload phase31 reports
        uses: actions/upload-artifact@v6
        with:
          name: phase31-reports
          path: |
            reports/oracle-runtime.json
            reports/render-baselines-real.json
            reports/render-verge-real.json
            reports/render-score-real.json
            reports/eval-phase31-summary.json
            scripts/oracles/oracle-image.lock.json
